name: Handle Dispatch Calls
on:
  repository_dispatch:
    types: [update-submodules]

jobs:
  forward:
    runs-on: ubuntu-latest
    steps:
      - name: Validate event payload
        run: |
          echo "ðŸ“¦ Type: ${{ github.event.client_payload.type }}"
          echo "ðŸ“› Name: ${{ github.event.client_payload.name }}"
          echo "ðŸ”— Repo: ${{ github.event.client_payload.repo }}"
          echo "ðŸ“ Subpath: ${{ github.event.client_payload.subpath }}"

      - name: Determine target hub
        id: map
        run: |
          TYPE="${{ github.event.client_payload.type }}"

          case "$TYPE" in
            project|app) HUB_REPO="ianhubnet/csk-projects" ;;
            module|plugin|theme|library|helper|service) HUB_REPO="ianhubnet/csk-packages" ;;
            language) HUB_REPO="ianhubnet/csk-languages" ;;
            *) echo "âŒ Unknown type: $TYPE"; exit 1 ;;
          esac

          echo "hub_repo=$HUB_REPO" >> $GITHUB_OUTPUT

      - name: Forward dispatch to hub repo
        run: |
          HUB_REPO="${{ steps.map.outputs.hub_repo }}"
          echo "ðŸš€ Forwarding update to $HUB_REPO..."

          PAYLOAD=$(jq -n \
            --arg name "${{ github.event.client_payload.name }}" \
            --arg type "${{ github.event.client_payload.type }}" \
            --arg repo "${{ github.event.client_payload.repo }}" \
            --arg subpath "${{ github.event.client_payload.subpath }}" \
            '{name: $name, type: $type, repo: $repo, subpath: $subpath}')

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.CSK_PAT }}" \
            "https://api.github.com/repos/$HUB_REPO/dispatches" \
            -d "{\"event_type\":\"update-submodules\",\"client_payload\":$PAYLOAD}"

          echo "âœ… Forwarded dispatch to $HUB_REPO"

      - name: Optional: Handle special language â†’ packages chaining
        if: ${{ github.event.client_payload.type == 'language' }}
        run: |
          echo "ðŸ”„ Language repo updated; will later notify csk-packages after csk-languages update."
